tinymce.PluginManager.add("agile_templates", function (editor, t) {
    function updateDom(format) {
        var selection = editor.selection.getContent({format: 'text'}).trim() || format.title;

        editor.insertContent(format.content.replace('%content%', selection));
    }

    var templates = editor.getParam('agile_templates');

    if (templates) {
        var menu = [];
        for (var i = 0; i < templates.length; ++i) {
            (function () {
                var format = templates[i];

                menu.push({
                    text: format.title,
                    classes: format.class,
                    onclick: function () {
                        updateDom(format);
                    }
                });
            })();
        }

        if (templates.length > 0) {
            editor.addButton('agile_templates', {
                type: 'menubutton',
                text: 'Templates',
                icon: false,
                menu: menu
            });
        }
    }
});
